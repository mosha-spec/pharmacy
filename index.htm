<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© - Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#27ae60">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --main: #2c3e50; --success: #27ae60; --danger: #e74c3c; --bg: #f8f9fa; --card: white; --text: #333; }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        body.dark-mode .container { background: var(--card); color: var(--text); }
        body.dark-mode table { color: var(--text); }
        body.dark-mode input { background: #2d2d2d; border-color: #444; color: white; }
        body.dark-mode tr:hover { background: #252525; }
        body.dark-mode .quick-stats { background: #2d2d2d; border: 1px solid #444; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: rtl; transition: 0.3s; }
        .container { max-width: 1250px; margin: auto; background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 12px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .qty-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; background: #f8f9fa; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #3498db; color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        .selected-row { background: rgba(52, 152, 219, 0.2) !important; }
        .p-name-link { cursor: pointer; color: #2980b9; transition: 0.2s; text-decoration: underline; }
        .quick-stats { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background: #eef2f3; border-radius: 12px; flex-wrap: wrap; align-items: center; }
        .stat-item { flex: 1; text-align: center; font-weight: bold; min-width: 120px; }
        .nav-btn { padding: 10px 15px; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
        #reader { width: 100%; max-width: 400px; margin: auto; display: none; border: 2px solid var(--main); border-radius: 10px; overflow: hidden; }
        .backup-section { margin-top: 20px; padding: 15px; background: #f1f2f6; border-radius: 12px; border: 1px dashed #ccc; text-align: center; }
        #invoiceCapture { position: fixed; top: -5000px; width: 350px; background: #fff; padding: 20px; border: 1px solid #333; text-align: center; color: #000; }
#watermark-logic {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 350px;
    opacity: 0.15; /* Ø®ÙŠØ§Ù„ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ */
    z-index: 9999; /* ÙÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆÙÙˆÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
    pointer-events: none;
}


#invoiceCapture {
    position: fixed;
    top: -9999px; /* Ø¨ØªÙØ¶Ù„ Ù…Ø³ØªØ®Ø¨ÙŠØ© Ø¹Ù†Ùƒ Ø¨Ø³ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨ØªØ´ÙˆÙÙ‡Ø§ */
    width: 450px;
    background: white url('icon.png') no-repeat center !important;
    background-size: 250px !important;
    padding: 20px;
}

    </style>
</head>
<body>
<img src="icon.png" id="watermark-logic">
<div id="invoiceCapture"></div>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ğŸ’Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© - Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h2>
        <div>
            <button onclick="toggleDarkMode()" class="nav-btn" style="background:#8e44ad;">ğŸŒ™</button>
            <button onclick="processBundleSale('cash')" id="finalSellBtn" class="nav-btn" style="background:var(--success); display:none;">âœ… Ø¨ÙŠØ¹ Ø§Ù„Ø±ÙˆØ´ØªØ© (<span id="selectedCount">0</span>)</button>
            <button onclick="processBundleSale('debt')" id="finalDebtBtn" class="nav-btn" style="background:#e67e22; display:none;">ğŸ“ Ø±ÙˆØ´ØªØ© Ø¢Ø¬Ù„</button>
        </div>
    </div>

    <div id="reader"></div>
    <div class="form-row">
        <input type="text" id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
        <input type="number" id="newPurchase" placeholder="Ø§Ù„Ø´Ø±Ø§Ø¡">
        <input type="number" id="newSale" placeholder="Ø§Ù„Ø¨ÙŠØ¹">
        <input type="number" id="newStock" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input type="text" id="newExpiry" placeholder="Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">
        <input type="text" id="newNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
        <button onclick="addProduct()" style="background:var(--success); color:white; border-radius:8px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="search" style="flex: 1; padding:12px;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ø±ÙˆØ´ØªØ©..." onkeyup="filter()">
        <button onclick="startScan()" style="background:var(--main); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">ğŸ“· Ø³ÙƒØ§Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>ØªØ­Ø¯ÙŠØ¯</th>
                <th>Ø§Ù„Ø§Ø³Ù… (Ø³Ø¬Ù„)</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø¥Ø¯Ø§Ø±Ø©</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="quick-stats">
        <input type="text" id="bundleCust" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="width:150px">
        <input type="text" id="bundlePhone" placeholder="ÙˆØ§ØªØ³Ø§Ø¨" style="width:120px">
        <div class="stat-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ´ØªØ©: <span id="bundleTotal">0</span> Ø¬.Ù…</div>
        <button onclick="generateStockImage()" class="nav-btn" style="background:var(--danger);">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</button>
        <button onclick="window.location.href='/debts.html'" class="nav-btn" style="background:#e67e22;">ğŸ“ Ø¯ÙØªØ± Ø§Ù„Ø´ÙƒÙƒ</button>
        <button onclick="window.location.href='/suppliers.html'" class="nav-btn" style="background:#34495e;">ğŸ¢ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</button>
        <button onclick="goDashboard()" class="nav-btn" style="background:var(--main);">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <div style="border:1px solid #ffcccc; padding:15px; border-radius:10px;">
            <h4 style="margin:0 0 10px 0; color:var(--danger)">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
            <input type="text" id="expR" placeholder="Ø§Ù„Ø³Ø¨Ø¨" style="width: 40%;"> 
            <input type="number" id="expA" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width: 30%;">
            <button onclick="addExp()" style="background:var(--danger); color:white; padding:8px; border-radius:5px; cursor:pointer;">Ø®ØµÙ… Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="backup-section">
            <button onclick="downloadBackup()" style="background:#7f8c8d; color:white; padding:10px 15px; border-radius:5px; border:none; cursor:pointer;">ğŸ“¥ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            <button onclick="document.getElementById('importFile').click()" style="background:#95a5a6; color:white; padding:8px 15px; border-radius:5px; border:none; cursor:pointer;">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
            <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
        </div>
    </div>
</div>

<div id="invoiceCapture">
    <div style="border-bottom:2px solid #3498db; margin-bottom:10px;">
        <h2 style="margin:0;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¬Ù…Ø¹Ø©</h2>
        <p id="invDate" style="font-size:12px;"></p>
        <p>Ø§Ù„Ø¹Ù…ÙŠÙ„: <span id="invCust"></span></p>
    </div>
    <table style="width:100%; border-collapse:collapse;">
        <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th></tr></thead>
        <tbody id="invBody"></tbody>
    </table>
    <h3 style="text-align:left; border-top:1px solid #000;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="invTotal"></span> Ø¬.Ù…</h3>
</div>

<script>
    let scanner;
    let selectedItems = new Set();

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }
    if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

    async function addExp() {
    const rIn = document.getElementById('expR');
    const aIn = document.getElementById('expA');
    
    const reason = rIn.value.trim();
    const amount = aIn.value;

    if (!reason || !amount) return;

    try {
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ù‡Ù†Ø§ Ù„ÙŠÙƒÙˆÙ† /add-expense Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù†Ø¯Ùƒ
        const response = await fetch('/add-expense', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                reason: reason, 
                amount: amount 
            })
        });

        if (response.ok) {
            // ØªÙ†ÙÙŠØ° Ø®ÙÙŠ: ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹
            rIn.value = '';
            aIn.value = '';
            console.log("ØªÙ… Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­");
        } else {
            alert("Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±ÙØ¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
    } catch (err) {
        alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
    }
}



    async function load() {
        const res = await fetch('/products');
        const data = await res.json();
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        data.forEach(p => {
            if (p.isDeleted) return;
            body.innerHTML += `
                <tr id="row_${p.id}" class="${selectedItems.has(p.id) ? 'selected-row' : ''}">
                    <td><input type="checkbox" onchange="toggleItem(${p.id})" ${selectedItems.has(p.id) ? 'checked' : ''}></td>
                    <td onclick="showItemHistory('${p.name}')" class="p-name-link"><b>${p.name}</b></td>
                    <td><input type="number" id="pr_${p.id}" value="${p.sale_price}" style="width:60px" onchange="updateTotal()"></td>
                    <td><b id="st_${p.id}" style="color:${p.stock < 5 ? 'red':'green'}">${p.stock}</b></td>
                    <td>
                        <button class="qty-btn" onclick="changeQty(${p.id},-1)">-</button>
                        <input type="number" id="qty_${p.id}" value="1" style="width:40px; text-align:center" onchange="updateTotal()">
                        <button class="qty-btn" onclick="changeQty(${p.id},1)">+</button>
                    </td>
                    <td><button onclick="del(${p.id})" style="background:none; border:none; cursor:pointer; font-size:18px;">ğŸ—‘ï¸</button></td>
                </tr>`;
        });
        updateTotal();
    }

    function toggleItem(id) {
        if (selectedItems.has(id)) selectedItems.delete(id);
        else selectedItems.add(id);
        document.getElementById(`row_${id}`).classList.toggle('selected-row');
        updateTotal();
    }

    function updateTotal() {
        let total = 0; let count = 0;
        selectedItems.forEach(id => {
            const qty = document.getElementById(`qty_${id}`).value;
            const price = document.getElementById(`pr_${id}`).value;
            total += (qty * price); count++;
        });
        document.getElementById('bundleTotal').innerText = total;
        document.getElementById('selectedCount').innerText = count;
        document.getElementById('finalSellBtn').style.display = count > 0 ? 'inline-block' : 'none';
        document.getElementById('finalDebtBtn').style.display = count > 0 ? 'inline-block' : 'none';
    }

    async function processBundleSale(type) {
    const cName = document.getElementById('bundleCust').value || "Ø¹Ù…ÙŠÙ„";
    const cPhone = document.getElementById('bundlePhone').value;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ§Øª (ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
    for (let id of selectedItems) {
        const stock = parseInt(document.getElementById('st_'+id).innerText);
        const q = parseInt(document.getElementById('qty_'+id).value);
        if (q > stock) return alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ù†Ø§Ù‚ØµØ© ÙÙŠ ${document.querySelector('#row_'+id+' b').innerText}`);
    }

    if (!confirm(`Ø­ÙØ¸ ÙˆØ¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© Ù„Ù€ ${selectedItems.size} Ø£ØµÙ†Ø§ÙØŸ`)) return;

    // --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Ø§Ù„Ù…ØµÙ…Ù… Ø§Ù„Ø°Ø§ØªÙŠ) ---
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 500;
    canvas.height = 500 + (selectedItems.size * 40);
    
    // Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ØµØ§ÙÙŠØ©
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Ø±Ø³Ù… Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø®ÙŠØ§Ù„ ÙÙŠ Ø§Ù„Ù†Øµ (Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©)
    const img = new Image();
    img.src = 'icon.png';
    ctx.globalAlpha = 0.1; 
    ctx.drawImage(img, 125, 150, 250, 250);
    ctx.globalAlpha = 1.0;

    // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
    ctx.fillStyle = '#2c3e50';
    ctx.textAlign = 'center';
    ctx.font = 'bold 26px Arial'; 
    ctx.fillText('ØµÙŠØ¯Ù„ÙŠØ© /Ø¯/Ù…Ø­Ù…Ø¯', 250, 60);
    
    ctx.font = '18px Arial';
    ctx.fillText(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${cName}`, 250, 100);
    ctx.fillText(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-EG')}`, 250, 130);

    let y = 200;
    let total = 0;

    // Ø­Ù„Ù‚Ø© Ø±Ø³Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØªØ±Ø§ÙƒÙ… Ø§Ù„Ø­Ø³Ø§Ø¨
selectedItems.forEach(id => {
    // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© ÙƒÙ€ Ø±Ù‚Ù… (Integer) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ­
    const q = parseInt(document.getElementById(`qty_${id}`).value); 
    const p = parseFloat(document.getElementById(`pr_${id}`).value);
    const name = document.querySelector(`#row_${id} b`).innerText;
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ†Ù (Ù…Ø«Ù„Ø§Ù‹ 90 * 3 = 270)
    const subTotal = q * p; 
    total += subTotal; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ

    ctx.textAlign = 'right';
    ctx.font = '18px Arial';
    // Ø±Ø³Ù… Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (x3 Ù…Ø«Ù„Ø§Ù‹)
    ctx.fillText(`${name} x${q}`, 450, y);
    // Ø±Ø³Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ØµÙ†Ù
    ctx.fillText(`${subTotal} Ø¬.Ù…`, 80, y);
    
    y += 40; // Ø§Ù„Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù
});


    // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¯Ø¹Ø§Ø¡
    ctx.beginPath(); ctx.moveTo(50, y); ctx.lineTo(450, y); ctx.stroke();
    ctx.font = 'bold 22px Arial';
    ctx.fillText(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬.Ù…`, 250, y + 50);
    
    ctx.fillStyle = 'green';
    ctx.textAlign = 'center'; 
    ctx.fillText('Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø´ÙØ§Ø¡Ù‹ Ø¹Ø§Ø¬Ù„Ø§Ù‹ Ù„Ø§ ÙŠØºØ§Ø¯Ø± Ø³Ù‚Ù…Ø§Ù‹ ğŸŒ¹', 250, y + 100);

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ù„ØµÙˆØ±Ø© ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
    const dataUrl = canvas.toDataURL("image/png");
    const downloadLink = document.createElement('a');
    downloadLink.download = `Ø±ÙˆØ´ØªØ©_${cName}.png`;
    downloadLink.href = dataUrl;
    downloadLink.click();
    // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø±Ø³Ù… ---

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ± (ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
    for (let id of selectedItems) {
        const q = document.getElementById(`qty_${id}`).value;
        const p = document.getElementById(`pr_${id}`).value;
        await fetch('/sales', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ product_id: id, quantity: q, sale_price: p, customer_name: cName, customer_phone: cPhone }) });
        if (type === 'debt') await fetch('/add-debt', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ customer_name: cName, amount: q*p, notes: 'Ø±ÙˆØ´ØªØ© Ø¢Ø¬Ù„' }) });
    }

    if (cPhone) window.open(`https://wa.me/2${cPhone}?text=${encodeURIComponent('Ø£Ù„Ù Ø³Ù„Ø§Ù…Ø© Ø¹Ù„ÙŠÙƒ/ÙŠ.. Ø¯ÙŠ Ø§Ù„Ø±ÙˆØ´ÙŠØªØ©')}`, '_blank');
    
    selectedItems.clear(); 
    load(); 
    alert("ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„Ø¨ÙŠØ¹!");
}


    function generateStockImage() {
        const limit = prompt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ÙˆØ§Ù‚Øµ:", "5");
        if (limit === null) return;
        const rows = document.querySelectorAll('#tableBody tr');
        let hasLow = false;
        rows.forEach(row => {
            const stock = parseInt(row.querySelector('b[id^="st_"]').innerText);
            if (stock < parseInt(limit)) { row.style.display = ''; hasLow = true; } else { row.style.display = 'none'; }
        });
        if (!hasLow) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ"); load(); return; }
        html2canvas(document.querySelector("#mainTable")).then(canvas => {
            const link = document.createElement('a'); link.download = `Ù†ÙˆØ§Ù‚Øµ.png`; link.href = canvas.toDataURL(); link.click();
            load();
        });
    }

    async function addProduct() {
        const d = { name: document.getElementById('newName').value, purchase_price: document.getElementById('newPurchase').value, sale_price: document.getElementById('newSale').value, stock: Number(document.getElementById('newStock').value), note: document.getElementById('newNote').value };
        await fetch('/products', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) });
        load();
    }

    function changeQty(id, delta) { let i = document.getElementById('qty_'+id); let v = parseInt(i.value) + delta; if(v > 0) i.value = v; updateTotal(); }
    async function del(id) { if(confirm("Ø­Ø°ÙØŸ")) { await fetch('/delete-product', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) }); load(); } }
    function filter() { let q = document.getElementById('search').value.toLowerCase(); document.querySelectorAll('#tableBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'); }
    async function downloadBackup() {
        const r1 = await fetch('/reports-data'); const d1 = await r1.json();
        const r2 = await fetch('/products'); const d2 = await r2.json();
        const backup = { products: d2, sales: d1.sales, expenses: d1.expenses };
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(backup)], {type:'application/json'})); a.download = `Ù†Ø³Ø®Ø©.json`; a.click();
    }
    function startScan() { document.getElementById('reader').style.display='block'; scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }); scanner.render((txt) => { document.getElementById('search').value=txt; filter(); scanner.clear(); document.getElementById('reader').style.display='none'; }); }
    function goDashboard() { if(prompt("Pass?") === "1") window.location.href='/dashboard'; }
    load();
</script>
</body>
</html>
