<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¯ÙØªØ± Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø´ÙƒÙƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e67e22; --success: #27ae60; --danger: #e74c3c; --dark: #2c3e50; }
        body { font-family: 'Cairo', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 10px; text-align: center; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; }
        .back-btn { background: var(--dark); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        
        .status-unpaid { color: var(--danger); font-weight: bold; }
        .status-paid { color: var(--success); font-weight: bold; text-decoration: line-through; }
        .pay-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-family: 'Cairo'; }
        .pay-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .summary { display: flex; gap: 20px; margin-top: 20px; background: #fff3e0; padding: 15px; border-radius: 10px; font-weight: bold; }
        .summary span { color: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <a href="/" class="back-btn">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <input type="text" id="debtSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="filterDebts()">
    </div>

    <h2>ğŸ“ Ø³Ø¬Ù„ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¯Ø§Ø±Ø©</th>
            </tr>
        </thead>
        <tbody id="debtsBody">
            </tbody>
    </table>

    <div class="summary">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„Ø©: <span id="totalUnpaid">0</span> Ø¬.Ù…
    </div>
</div>

<script>
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    async function loadDebts() {
        const res = await fetch('/debts-data');
        const debts = await res.json();
        const body = document.getElementById('debtsBody');
        body.innerHTML = '';
        
        let total = 0;

        debts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(debt => {
            if (!debt.isPaid) total += Number(debt.amount);

            body.innerHTML += `
                <tr class="debt-row">
                    <td>${new Date(debt.date).toLocaleDateString('ar-EG')}</td>
                    <td class="c-name">${debt.customer_name}</td>
                    <td class="c-phone">${debt.customer_phone}</td>
                    <td><b>${debt.amount} Ø¬.Ù…</b></td>
                    <td class="${debt.isPaid ? 'status-paid' : 'status-unpaid'}">
                        ${debt.isPaid ? 'ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ âœ…' : 'Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ âŒ'}
                    </td>
                    <td>
                        <button class="pay-btn" ${debt.isPaid ? 'disabled' : ''} onclick="payDebt(${debt.id})">
                            ${debt.isPaid ? 'Ù…ÙƒØªÙ…Ù„' : 'ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº'}
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('totalUnpaid').innerText = total.toFixed(2);
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ†
    async function payDebt(id) {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ„Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
            const res = await fetch('/pay-debt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            
            if (res.ok) {
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ (ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯) Ø¨Ù†Ø¬Ø§Ø­!");
                loadDebts();
            }
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function filterDebts() {
        let q = document.getElementById('debtSearch').value.toLowerCase();
        document.querySelectorAll('.debt-row').forEach(row => {
            const name = row.querySelector('.c-name').innerText.toLowerCase();
            const phone = row.querySelector('.c-phone').innerText.toLowerCase();
            row.style.display = (name.includes(q) || phone.includes(q)) ? '' : 'none';
        });
    }

    // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„
    loadDebts();
</script>

</body>
</html>

