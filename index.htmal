<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #2c3e50; --success: #27ae60; --danger: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 12px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .qty-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; background: #f8f9fa; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #3498db; color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        .quick-stats { display: flex; gap: 20px; margin-top: 20px; padding: 15px; background: #eef2f3; border-radius: 12px; }
        .stat-item { flex: 1; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø°ÙƒÙŠ</h2>

    <div class="form-row">
        <input type="text" id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
        <input type="number" id="newPurchase" placeholder="Ø§Ù„Ø´Ø±Ø§Ø¡">
        <input type="number" id="newSale" placeholder="Ø§Ù„Ø¨ÙŠØ¹">
        <input type="number" id="newStock" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input type="text" id="newExpiry" placeholder="Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">
        <input type="text" id="newNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©">
        <button onclick="addProduct()" style="background:var(--success); color:white; border-radius:8px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <input type="text" id="search" style="width:100%; padding:12px; margin-bottom:15px;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§..." onkeyup="filter()">

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ø±Ù‚Ù…</th>
                <th>Ø¥Ø¯Ø§Ø±Ø©</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="quick-stats">
        <div class="stat-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù: <span id="count">0</span></div>
        <div class="stat-item">Ù†ÙˆØ§Ù‚Øµ (Ø£Ù‚Ù„ Ù…Ù† 5): <span id="lowStock" style="color:red">0</span></div>
        <button onclick="generateStockImage()" style="background:var(--danger); color:white; padding:10px 20px; border-radius:10px; cursor:pointer; margin-left:10px;">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</button>
        <button onclick="window.location.href='/debts.html'" style="background:#e67e22; color:white; padding:10px 20px; border-radius:10px; cursor:pointer; margin-left:10px;">ğŸ“ Ø¯ÙØªØ± Ø§Ù„Ø´ÙƒÙƒ</button>
        <button onclick="goDashboard()" style="background:var(--main); color:white; padding:10px 30px; border-radius:10px; cursor:pointer;">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù…Ø­Ù…ÙŠ)</button>
    </div>

    <div style="margin-top:20px; border:1px solid #ffcccc; padding:15px; border-radius:10px;">
        <h4 style="margin:0 0 10px 0; color:var(--danger)">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
        <input type="text" id="expR" placeholder="Ø§Ù„Ø³Ø¨Ø¨"> <input type="number" id="expA" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <button onclick="addExp()" style="background:var(--danger); color:white; padding:8px; border-radius:5px; cursor:pointer;">Ø®ØµÙ… Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="printArea" style="display:none; direction:rtl; font-family:Arial; padding:20px; border:2px solid #000;">
    <h2 style="text-align:center;">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© ØµÙŠØ¯Ù„ÙŠØ©</h2>
    <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="pf_date"></span></p>
    <hr>
    <p>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡: <b id="pf_name"></b></p>
    <p>Ø§Ù„ÙƒÙ…ÙŠØ©: <b id="pf_qty"></b></p>
    <p>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: <b id="pf_price"></b> Ø¬.Ù…</p>
    <hr>
    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„Ù€ÙˆØ¨: <span id="pf_total"></span> Ø¬.Ù…</h3>
    <p style="text-align:center;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… - Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„Ø´ÙØ§Ø¡</p>
</div>

<script>
    async function load() {
        const res = await fetch('/products');
        const data = await res.json();
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        let low = 0;
        data.forEach(p => {
            if (p.isDeleted) return;
            const isLow = p.stock < 5;
            if(isLow) low++;
            const rowBg = isLow ? 'style="background-color: #fff0f0;"' : '';

            body.innerHTML += `
                <tr id="row_${p.id}" ${rowBg}>
                    <td><b class="p-name">${p.name}</b><br><small style="color:blue">${p.note || ''}</small></td>
                    <td><input type="number" id="pr_${p.id}" value="${p.sale_price}" style="width:60px"></td>
                    <td><b style="color:${isLow ? 'red':'green'}">${p.stock}</b></td>
                    <td>
                        <button class="qty-btn" onclick="changeQty(${p.id},-1)">-</button>
                        <input type="number" id="qty_${p.id}" value="1" style="width:40px; text-align:center">
                        <button class="qty-btn" onclick="changeQty(${p.id},1)">+</button>
                    </td>
                    <td>
                        <input type="text" id="cn_${p.id}" placeholder="Ø§Ù„Ø¹Ù…ÙŠÙ„" style="width:70px">
                        <input type="text" id="cp_${p.id}" placeholder="Ø§Ù„Ø±Ù‚Ù…" style="width:80px">
                        <div style="display:flex; gap:3px; margin-top:5px;">
                            <button onclick="sell(${p.id}, 'cash')" style="background:#f1c40f; border:none; padding:5px; cursor:pointer; border-radius:5px; flex:1; font-size:12px;">Ø¨ÙŠØ¹</button>
                            <button onclick="sell(${p.id}, 'debt')" style="background:#e67e22; border:none; padding:5px; color:white; cursor:pointer; border-radius:5px; flex:1; font-size:11px;">Ø¢Ø¬Ù„ ğŸ¥µ</button>
                        </div>
                    </td>
                    <td><button onclick="del(${p.id})" style="background:none; cursor:pointer; font-size:18px;">ğŸ—‘ï¸</button></td>
                </tr>`;
        });
        document.getElementById('count').innerText = data.filter(x=>!x.isDeleted).length;
        document.getElementById('lowStock').innerText = low;
    }

    async function generateStockImage() {
        const res = await fetch('/products');
        const data = await res.json();
        const lowStockItems = data.filter(p => p.stock < 5 && !p.isDeleted);
        
        if(lowStockItems.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ Ø­Ø§Ù„ÙŠØ§Ù‹");

        let modalHTML = `
            <div id="modalOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; direction:rtl;">
                <div style="background:white; padding:20px; border-radius:15px; width:90%; max-width:500px;">
                    <div id="captureArea" style="padding:15px; background:white;">
                        <h2 style="text-align:center; color:#2c3e50; border-bottom:2px solid #3498db; margin-bottom:15px; padding-bottom:10px;">ğŸ“‹ Ø·Ù„Ø¨ÙŠØ© Ù†ÙˆØ§Ù‚Øµ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h2>
                        <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                            <thead style="background:#f8f9fa;">
                                <tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th></tr>
                            </thead>
                            <tbody>
                                ${lowStockItems.map(i => `
                                    <tr>
                                        <td style="padding:8px;"><b>${i.name}</b></td>
                                        <td style="padding:8px; color:red;">${i.stock}</td>
                                        <td style="padding:8px;"><input type="number" class="order-qty" placeholder="0" style="width:60px; text-align:center; border:1px solid #ddd;"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align:center; margin-top:20px;">
                        <button id="doCapture" style="background:#27ae60; color:white; padding:10px 25px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
                        <button onclick="document.getElementById('modalOverlay').remove()" style="background:#95a5a6; color:white; padding:10px 25px; border:none; border-radius:8px; cursor:pointer; margin-right:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

        document.getElementById('doCapture').onclick = function() {
            const inputs = document.querySelectorAll('.order-qty');
            inputs.forEach(input => {
                const val = input.value || "0";
                const textNode = document.createElement('b');
                textNode.innerText = val;
                textNode.style.color = "#27ae60";
                input.parentNode.replaceChild(textNode, input);
            });

            html2canvas(document.getElementById('captureArea')).then(canvas => {
                const link = document.createElement('a');
                link.download = `Ù†ÙˆØ§Ù‚Øµ_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                document.getElementById('modalOverlay').remove();
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            });
        };
    }

    function changeQty(id, v) { let el = document.getElementById('qty_'+id); el.value = Math.max(1, Number(el.value) + v); }

    async function addProduct(force=false) {
        const d = { 
            name: document.getElementById('newName').value, 
            purchase_price: document.getElementById('newPurchase').value, 
            sale_price: document.getElementById('newSale').value, 
            stock: Number(document.getElementById('newStock').value),
            note: document.getElementById('newNote').value,
            force: force 
        };
        const res = await fetch('/products', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) });
        const resJ = await res.json();
        if(resJ.askToMerge) { if(confirm("Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¯Ù…Ø¬ØŸ")) addProduct(true); } else { load(); clearInputs(); }
    }

    function clearInputs() {
        document.getElementById('newName').value = ''; document.getElementById('newPurchase').value = '';
        document.getElementById('newSale').value = ''; document.getElementById('newStock').value = '';
        document.getElementById('newNote').value = '';
    }

    async function sell(id, type = 'cash') {
        const qty = document.getElementById('qty_'+id).value;
        const price = document.getElementById('pr_'+id).value;
        const cName = document.getElementById('cn_'+id).value || "Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªØ±Ù…";
        const cPhone = document.getElementById('cp_'+id).value || "---";
        const dName = document.querySelector(`#row_${id} .p-name`).innerText;

        const d = { product_id: id, quantity: qty, sale_price: price, customer_name: cName, customer_phone: cPhone };
        const res = await fetch('/sales', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) });
        
        if(res.ok) { 
            if(type === 'debt') {
                const debtData = {
                    customer_name: cName,
                    customer_phone: cPhone,
                    amount: Number(qty) * Number(price),
                    notes: `Ø¢Ø¬Ù„: ${dName}`
                };
                await fetch('/add-debt', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(debtData) });
                alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                alert("ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ");
            }

            if(cPhone && cPhone.trim() !== "" && cPhone !== "---") {
                if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
                    const total = Number(qty) * Number(price);
                    const statusText = type === 'debt' ? "(Ø¢Ø¬Ù„ - Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©)" : "(ÙƒØ§Ø´)";
                    const message = `*ğŸ§¾ ÙØ§ØªÙˆØ±Ø© ØµÙŠØ¯Ù„ÙŠØ©*%0A*Ø§Ù„Ø­Ø§Ù„Ø©:* ${statusText}%0A*Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${cName}%0A*Ø§Ù„ØµÙ†Ù:* ${dName}%0A*Ø§Ù„ÙƒÙ…ÙŠØ©:* ${qty}%0A*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* ${total} Ø¬.Ù…%0A*Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ…*`;
                    window.open(`https://wa.me/2${cPhone}?text=${message}`, '_blank');
                }
            }
            load(); 
        } else { 
            const ej = await res.json(); alert(ej.message); 
        }
    }

    async function del(id) { if(confirm("Ø­Ø°ÙØŸ")) { await fetch('/delete-product', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) }); load(); } }

    async function addExp() {
        const reason = document.getElementById('expR').value;
        const amount = document.getElementById('expA').value;
        await fetch('/add-expense', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({reason, amount}) });
        alert("ØªÙ… Ø§Ù„Ø®ØµÙ…"); load();
    }

    function goDashboard() { if(prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1") window.location.href='/dashboard'; else alert("Ø®Ø·Ø£!"); }
    function filter() { 
        let q = document.getElementById('search').value.toLowerCase(); 
        document.querySelectorAll('#tableBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'); 
    }
    load();
</script>
</body>
</html>

